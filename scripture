#!/usr/bin/bash

# Usage sanitization
[ -z "$1" ] && echo "usage: scripture <deck file>" && exit 1

# TSV by default, otherwise use user's preference
DELIMITER=${SCRIPTURE_DELIMITER:-"	"}

# Determine which cards need to be reviewed
rm /tmp/scripture 2> /dev/null
rm /tmp/scripture_lt4 2> /dev/null
while read -r line
do
	# Get epoch time of last review
	output=$(echo "$line" | cut -d"$DELIMITER" -f 6)
	output=$(date +%s -d"$output")

	# See if time since last review outlasts inter_repetition_interval (I)
	# 86400 --> num of seconds in 24 hours
	I=$(echo "$line" | cut -d"$DELIMITER" -f 5)
	time_since=$(echo "$(date +%s) - $output" | bc -l)

	# Does time since last review fulfills I's requirement
	[ "$time_since" -gt "$(echo "$I * 86400" | bc -l)" ] && echo "$line" >> /tmp/scripture
done < "$1"

# Delegate reviewing
review_card () {
	# input: $1 - card to review
	# output: new card

	clear

	# Get the Front and Back of your card
	front=$(echo "$1" | cut -d"$DELIMITER" -f 1)
	back=$(echo "$1" | cut -d"$DELIMITER" -f 2)

	# Get grade (q) from user
	read -rp "$front" </dev/tty
	echo "$back"
	echo

	# Loop until user gives a valid answer
	while :
	do
		read -rp "Enter your grade (0-5): " q < /dev/tty
		echo "$q" | grep "^[0-5]$" > /dev/null && break
	done
	
	# SM-2 calculation

	# n - repetition number
	n=$(echo "$1" | cut -d"$DELIMITER" -f 3)
	# EF - easiness factor
	EF=$(echo "$1" | cut -d"$DELIMITER" -f 4)
	# I - interval
	I=$(echo "$1" | cut -d"$DELIMITER" -f 5)

	# Split depending on q >= 3 or not
	correct_response=0
	[ "$q" -ge 3 ] && correct_response=1
	case $correct_response in
		1)
			# Correct response
			case "$n" in
				0) I=1 ;;
				1) I=6 ;;
				*) I=$(echo "$I * $EF" | bc -l) ;;
			esac

			EF=$(echo "$EF + (0.1 - (5 - $q) * (0.08 + (5 - $q) * 0.02))" | bc -l)
			[ "$(echo "$EF < 1.3" | bc -l)" == 1 ] && EF=1.3

			# Increment n
			n=$(echo "n + 1" | bc -l)

			;;
		0)
			# Incorrect response
			n=0
			I=1

			;;
	esac

	# Create new line
	echo "$front$DELIMITER$back$DELIMITER$n$DELIMITER$EF$DELIMITER$I$DELIMITER$(date -I)"
}

update_deck () {
	# input: $1 - old card, $2 - new card, $3 - deck file
	# no output: just updating

	# Both lines have to be escaped
	# 's/[]\/()$*.^|[]/\\&/g' is wrong! Do NOT escape () anywhere!

	# Escape lines
	new_line_escaped="$(echo "$2" | sed -e 's/[]$*.^|[]/\\&/g')"
	old_line_escaped="$(echo "$1" | sed -e 's/[]$*.^|[]/\\&/g')"

	# Make the replacement
	sed -i "s/^$old_line_escaped\$/$new_line_escaped/" "$3"
}

# Review each card
while read -r line
do
	# Review the card
	new_line_raw=$(review_card "$line")

	# Update the deck file
	update_deck "$line" "$new_line_raw" "$1"

	# SM-2 asks the user to "re-review any cards they marked with a grade less than 4 repeatedly until they give a grade â‰¥ 4"
	# So, we need to create a list of these re-review cards

	# If the grade is less than four, add the card to the list
	[ "$q" -lt 4 ] && echo $new_line_raw >> /tmp/scripture_lt4

done < /tmp/scripture

# Start reviewing lt4 cards
mv /tmp/scripture_l4 /tmp/scripture

# (review)
